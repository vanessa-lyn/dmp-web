<html>
    <head>
        <title>Control Tag</title>
        <!-- BEGIN ControlTag for "Trade Me" -->
        <!-- <script async class="kxct" data-id="J7iwbVZL" data-timing="async" data-version="3.0">
            window.Krux||((Krux=function(){Krux.q.push(arguments)}).q=[]);
            (function(){
                var k=document.createElement('script');k.type='text/javascript';k.async=true;
                k.src=(location.protocol==='https:'?'https:':'http:')+'//cdn.krxd.net/controltag/J7iwbVZL.js';
                var s=document.getElementsByTagName('script')[0];s.parentNode.insertBefore(k,s);
            }());
            //prod: J6xELiDv
            //test: J7iwbVZL
        </script> -->
        <!-- END ControlTag -->
        <script class="kxct" data-id="J6xELiDv" data-timing="async" data-version="3.0" type="text/javascript">
        function implementControlTag () {
            //adding script
            console.log('adding control tag script');
            window.Krux||((Krux=function(){Krux.q.push(arguments)}).q=[]);
            // (function(){
            var k=document.createElement('script');k.type='text/javascript';k.async=true;
            k.src=(location.protocol==='https:'?'https:':'http:')+'//cdn.krxd.net/controltag/J6xELiDv.js';
            var s=document.getElementsByTagName('script')[0];s.parentNode.insertBefore(k,s);
            // }());

        }

        </script>
        <script>
            // window.dataLayer = [{'gtm.start': 1573601241034, 'event': 'gtm.js', 'gtm.uniqueEventId': 0},{'gtm.start': 1573601241034, 'event': 'gtm.js', 'gtm.uniqueEventId': 0},{"userId":"Ur8KXZ0VdhtNcMZeYo/i5KRBFNR4FFG6oVbhRJFO7HQ===","frendVersion":"4cbe6bd8d44e","gtm.uniqueEventId":2},{"categoryLevel1":"trade-me-property","categoryLevel2":"residential","categoryLevel3":"for-sale","category":"/Trade-Me-Property/Residential/For-Sale","canonicalPath":"/property/residential/sale/waikato/hamilton/frankton/listing/1809228979","vertical":"property","name":"Residential for sale","id":1809228979,"mcat":"0350-5748-3399-","auctionOrClassified":"classified","region":"Waikato","district":"Hamilton","isClosed":"false","sellerRegion":"Auckland","sellerDistrict":"Manukau","sellerInTrade":"false","hasPhotos":"true","hasVideo":"false","newOrUsed":"used","hasBuyNow":"false","hasPayNow":"false","freeShipping":"false","mustPickUp":"false","url":"/property/residential/sale/waikato/hamilton/frankton/listing/1809228979","event":"pageView","userId":"","frendVersion":"4cbe6bd8d44e","gtm.uniqueEventId":5},{"event":"gtm.dom","gtm.uniqueEventId":9},{"event":"gtm.load","gtm.uniqueEventId":12}];
        </script>
    </head>
    <body>
        <script class="kxint" data-namespace="trademe">
            window.Krux||((Krux=function(){Krux.q.push(arguments);}).q=[]);
            //(function(){
              function retrieve(n){
                var k= 'kx'+'trademe_'+n, ls=(function(){
                  try {
                    return window.localStorage;
                  } catch(e) {
                    return null;
                  }
                })();
                if (ls) {
                    return ls[k] || '';
                } else if (navigator.cookieEnabled) {
                    var m = document.cookie.match(k+'=([^;]*)');
                    return (m && unescape(m[1])) || '';
                } else {
                    return '';
                }
              }
               Krux.user = retrieve('user');
               Krux.segments = retrieve('segs') ? retrieve('segs').split(',') : [];
            // })();

            </script>


            <script>
             
            // (function () {
            //     var parentWindow = window.document.location.ancestorOrigins[0];
            //     if (parentWindow.includes('trademe.co.nz')) {
            //         let intervalID = setInterval(() => {
            //             if (Krux.segments.length == 0) {
            //                 return;
            //             }
            //             clearInterval(intervalID);
            //             parent.postMessage(Krux.segments, parentWindow);
            //         }, 500);
            //     }
            // })();



    //    listening for data from TM then sending to krux
            //listen for data being sent from TM via the sandbox
            (function () {
                window.addEventListener('message', function(e) {
                    console.log('origin', e.origin);
                    console.log('endswith ', e.origin.endsWith('trademe.co.nz'), e.origin.endsWith('trademe.co.nz:5000'));

                    if ((e.origin.endsWith('trademe.co.nz')) || (e.origin.endsWith('trademe.co.nz:5000'))) {
                        console.log('event', e.data);
                        
                        if ((e.data != null) && (typeof e.data === 'object') && (!!JSON.stringify(e.data))) {
                            console.log("data is okay");
                            console.log("and it is", e.data);

                            switch (e.data['type']) {
                                case "dataLayer":
                                    sendDataLayerToKrux(e.data['data']);
                                    break;
                                case "sponsoredTool":
                                    toolTracking(e.data['data']);
                                    break;
                            }
                        }
                        else {
                            console.log('something is wrong with the data');
                        }
                    }
                    else {
                        console.log('not the origin');
                    }
                }, false);

            })();


            function sendDataLayerToKrux(dLayer) {
                window.dataLayer = dLayer;
                console.log("DL == ", window.dataLayer);
                console.log('send please');

                implementControlTag();
                // ////
                // // Note: Requires JavaScript ControlTag to be deployed on the page
                // // BEGIN AJAX ControlTag for "Trade Me Test"
                // Krux('ns:trademe', 'page:load', function(err) {
                // /* Optional, called just after the tags are finished loading.
                //     If err is not null, then something went wrong. (err will be an instanceof Error or null.)
                // */
                //     if(err){console.log('Krux error='+err)}

                // }, {pageView: false /* Set to false if you don't want this counted as a page view. */});
                // // END AJAX ControlTag
                // ////

            }

        
            // function sendAudienceSegmentsToSite() {
            //     console.log("sending segments back");
            //     var parentWindow = window.document.location.ancestorOrigins[0];
            //     if (parentWindow.includes('trademe.co.nz')) {
            //         let intervalID = setInterval(() => {
            //             if (Krux.segments.length == 0) {
            //                 return;
            //             }
            //             clearInterval(intervalID);
            //             parent.postMessage(Krux.segments, parentWindow);
            //         }, 500);
            //     }
            // }


            //sending event data when user interacts with a tool
            // function toolTracking(evttype, tgt) {
            //     console.log('send to dmp', advert, evttype, tgt);
            //     window.Krux||((Krux=function(){Krux.q.push(arguments);}).q=[]);
            //     Krux('ns:trademe','admEvent', 'M5yYu2nj', {event_type:'default', advertiser:advert, event:evttype, target:tgt});
            // }

            function toolTracking(event) {
                console.log('send to dmp', event[0], event[1], event[2]);
                window.Krux||((Krux=function(){Krux.q.push(arguments);}).q=[]);
                Krux('ns:trademe','admEvent', 'M5yYu2nj', {event_type:'default', advertiser:event[0], event:event[1], target:event[2]});
            }

        </script>

    </body>

</html>